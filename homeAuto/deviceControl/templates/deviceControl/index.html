<!DOCTYPE html>
<html>

<head>
    <title>{% block title %}{% endblock %}</title>
    {% load bootstrap5 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>

<body>

    <div class="container-fluid">

        <div class="col-4">
            {% if device_list %}
            <ul class="nav bg-info">
                {% for device in device_list %}
                <li class="nav-item">
                    {% if device.state %}
                    <button type="button" id="{{ device.name }}" name="{{ device.name }}" class="btn btn-warning">{{ device.display_name }}</button>
                    {% else %}
                    <button type="button" id="{{ device.name }}" name="{{ device.name }}" class="btn btn-secondary">{{ device.display_name }}</button>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p>No devices are available.</p>
            {% endif %}

            {% block content %}
            {% endblock %}
        </div>
    </div>
    {{ room_name|json_script:"room-name" }}
    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        console.log(roomName)
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/deviceControl/'
            + roomName
            + '/'
        );

        console.log(chatSocket.url)

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("recieved message")
            console.log(data)
            console.log(data.message.state)
            

            if(data.message.state) {
                console.log('Its trueeeee')
                $(`#${data.message.id}`).removeClass( "btn-secondary" ).addClass( "btn-warning" );
                
            } else {
                console.log('Its false')
                $(`#${data.message.id}`).removeClass( "btn-warning" ).addClass( "btn-secondary" );
            }
            
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        $('button').on('click', function(e) {
            console.log(`ButtonID on click = ${e.target.id}`)

            chatSocket.send(JSON.stringify({
                'message': {
                    'type': 'sonoff',
                    'deviceId': e.target.id
                } 
            }));
        })
    </script>
</body>

</html>